{% extends "base.html" %}
{% load i18n finance_extras %}
{% block title %}Transactions Â· Finance Manager{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
  <div>
    <h1 class="h3 mb-1">{% trans "Transactions" %}</h1>
    <p class="text-muted mb-0">{% trans "Track every income and expense." %}</p>
  </div>
  <div class="btn-group" role="group" aria-label="{% trans 'Transactions actions' %}">
    <a href="{% url 'finance:transaction_create' %}" class="btn btn-primary">{% trans "New transaction" %}</a>
    <a href="{% url 'finance:transaction_import' %}" class="btn btn-outline-secondary">{% trans "Import CSV" %}</a>
    <div class="btn-group" role="group">
      <button
        id="exportDropdown"
        type="button"
        class="btn btn-outline-secondary dropdown-toggle"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        {% trans "Export" %}
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
        <li>
          <a class="dropdown-item" href="{% url 'finance:transaction_export' %}?format=csv{% if querystring %}&{{ querystring }}{% endif %}">
            {% trans "Export CSV" %}
          </a>
        </li>
        <li>
          <a class="dropdown-item" href="{% url 'finance:transaction_export' %}?format=json{% if querystring %}&{{ querystring }}{% endif %}">
            {% trans "Export JSON" %}
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

<div class="card mb-4 border-0 shadow-sm">
  <div class="card-body">
    <form method="get" class="row gy-3 gx-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label" for="{{ filter_form.account.id_for_label }}">{% trans "Account" %}</label>
        {{ filter_form.account }}
      </div>
      <div class="col-md-3">
        <label class="form-label" for="{{ filter_form.category.id_for_label }}">{% trans "Category" %}</label>
        {{ filter_form.category }}
      </div>
      <div class="col-md-2">
        <label class="form-label" for="{{ filter_form.start_date.id_for_label }}">{% trans "Start date" %}</label>
        {{ filter_form.start_date }}
      </div>
      <div class="col-md-2">
        <label class="form-label" for="{{ filter_form.end_date.id_for_label }}">{% trans "End date" %}</label>
        {{ filter_form.end_date }}
      </div>
      <div class="col-md-2">
        <label class="form-label" for="{{ filter_form.tags.id_for_label }}">{% trans "Tags" %}</label>
        {{ filter_form.tags }}
      </div>
      <div class="col-md-3">
        <label class="form-label" for="{{ filter_form.search.id_for_label }}">{% trans "Description" %}</label>
        {{ filter_form.search }}
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-primary w-100">{% trans "Apply" %}</button>
      </div>
      <div class="col-md-2">
        <a href="{% url 'finance:transaction_list' %}" class="btn btn-outline-secondary w-100">{% trans "Clear" %}</a>
      </div>
    </form>
  </div>
</div>

{% if transactions %}
<div class="table-responsive">
  <table class="table table-hover align-middle" aria-label="{% trans "Transactions table" %}">
    <thead class="table-light">
      <tr>
        <th scope="col">{% trans "Date" %}</th>
        <th scope="col">{% trans "Description" %}</th>
        <th scope="col">{% trans "Account" %}</th>
        <th scope="col">{% trans "Category" %}</th>
        <th scope="col" class="text-end">{% trans "Amount" %}</th>
        <th scope="col">{% trans "Tags" %}</th>
        <th scope="col" class="text-center">{% trans "Attachment" %}</th>
        <th scope="col" class="text-end">{% trans "Actions" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for transaction in transactions %}
      <tr>
        <td>{{ transaction.date }}</td>
        <td>{{ transaction.description|default:_("(no description)") }}</td>
        <td>{{ transaction.account.name }}</td>
        <td>{{ transaction.category|default:"â€”" }}</td>
        <td class="text-end {% if transaction.is_expense %}text-danger{% else %}text-success{% endif %}">
          {% if transaction.is_expense %}-{% endif %}{{ transaction.amount }} {{ transaction.currency }}
        </td>
        <td>
          {% if transaction.tags %}
            {% for tag in transaction.tags|split_tags %}
              <span class="badge tag-badge">{{ tag }}</span>
            {% endfor %}
          {% else %}
            <span class="text-muted">â€”</span>
          {% endif %}
        </td>
        <td class="text-center">
          {% if transaction.attachment %}
            <a href="{{ transaction.attachment.url }}" class="attachment-link" target="_blank" rel="noopener" aria-label="{% trans 'View attachment' %}">ðŸ“Ž</a>
          {% else %}
            <span class="text-muted">â€”</span>
          {% endif %}
        </td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <a href="{% url 'finance:transaction_update' transaction.pk %}" class="btn btn-outline-secondary">{% trans "Edit" %}</a>
            <a href="{% url 'finance:transaction_delete' transaction.pk %}" class="btn btn-outline-danger">{% trans "Delete" %}</a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if is_paginated %}
<nav aria-label="Transactions pagination">
  <ul class="pagination">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}
    {% for num in paginator.page_range %}
    <li class="page-item {% if num == page_obj.number %}active{% endif %}">
      <a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a>
    </li>
    {% endfor %}
    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% else %}
<div class="alert alert-info">{% trans "No transactions found for the selected filters." %}</div>
{% endif %}
{% endblock %}
